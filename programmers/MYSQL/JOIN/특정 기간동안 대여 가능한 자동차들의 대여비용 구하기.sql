-- https://school.programmers.co.kr/learn/courses/30/lessons/157339
-- 코드를 입력하세요
-- select * FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN

-- SELECT
-- *
-- FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
-- WHERE (START_DATE < "2022-11-01" AND END_DATE > "2022-11-30") OR (START_DATE < "2022-11-01" AND END_DATE >= "2022-11-01" AND END_DATE <= "2022-11-30") OR (START_DATE >= "2022-11-01" AND START_DATE <= "2022-11-30" AND END_DATE > "2022-11-30") OR (START_DATE >= "2022-11-01" AND END_DATE <= "2022-11-30")

WITH cte AS (
    SELECT
        CAR_ID,
        CASE CAR_TYPE
                WHEN "세단" THEN DAILY_FEE * 30 * (100 - CAST(REPLACE((SELECT DISCOUNT_RATE FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN WHERE DURATION_TYPE = "30일 이상" AND CAR_TYPE = "세단"), '%', '') AS DECIMAL)) / 100.0 
                WHEN "SUV" THEN DAILY_FEE * 30 * (100 - CAST(REPLACE((SELECT DISCOUNT_RATE FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN WHERE DURATION_TYPE = "30일 이상" AND CAR_TYPE = "SUV"), '%', '') AS DECIMAL)) / 100.0 
            END AS FEE
    FROM CAR_RENTAL_COMPANY_CAR
)


SELECT
CAR_RENTAL_COMPANY_CAR.CAR_ID,
CAR_RENTAL_COMPANY_CAR.CAR_TYPE,
# CAR_RENTAL_COMPANY_CAR.DAILY_FEE,
CAST(cte.FEE AS SIGNED) AS FEE
FROM CAR_RENTAL_COMPANY_CAR
JOIN cte ON (CAR_RENTAL_COMPANY_CAR.CAR_ID = cte.CAR_ID)
WHERE CAR_RENTAL_COMPANY_CAR.CAR_TYPE IN ("세단", "SUV") AND cte.FEE < 2000000 AND cte.FEE >= 500000 AND CAR_RENTAL_COMPANY_CAR.CAR_ID NOT IN (SELECT
CAR_ID
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
WHERE (START_DATE < "2022-11-01" AND END_DATE > "2022-11-30") OR (START_DATE < "2022-11-01" AND END_DATE >= "2022-11-01" AND END_DATE <= "2022-11-30") OR (START_DATE >= "2022-11-01" AND START_DATE <= "2022-11-30" AND END_DATE > "2022-11-30") OR (START_DATE >= "2022-11-01" AND END_DATE <= "2022-11-30"))
ORDER BY FEE DESC, CAR_TYPE, CAR_ID DESC
